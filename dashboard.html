<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triage Dashboard - Case Review</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .hidden { display: none; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .nav-active { border-bottom-color: #4f46e5; color: #111827; font-weight: 600; }
        .nav-inactive { border-bottom-color: transparent; color: #6b7280; }
        .urgency-Red { border-left-color: #dc2626; }
        .urgency-Amber { border-left-color: #d97706; }
        .urgency-Green { border-left-color: #16a34a; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-available { background-color: #22c55e; }
        .status-locked { background-color: #f59e0b; }
        .status-completed { background-color: #6b7280; }
        .case-card-completed { opacity: 0.6; background-color: #f3f4f6; }
        .truncate-2-lines { overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div id="header-controls" class="hidden max-w-6xl mx-auto p-4 flex justify-between items-center">
            <h1 id="header-title" class="text-2xl font-bold text-gray-800">Triage Dashboard</h1>
            <button id="logout-btn" class="ml-4 text-sm text-gray-500 hover:underline">Logout</button>
        </div>
         <div id="app-nav" class="hidden max-w-6xl mx-auto border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <a href="#" id="nav-sessions" class="nav-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Sessions</a>
                <a href="#" id="nav-scenarios" class="nav-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Scenario Editor</a>
                <a href="#" id="nav-admin" class="nav-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">User Management</a>
            </nav>
        </div>
    </header>
    <main class="p-4 sm:p-6 max-w-6xl mx-auto w-full">
        <div id="loading-view" class="text-center p-8"><p>Loading...</p></div>
        <div id="auth-view" class="hidden"></div>
        <div id="access-denied-view" class="hidden"></div>
        <div id="app-view" class="hidden w-full"></div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <script>
    // STEP 1: INITIALIZE FIREBASE
        if (window.firebaseConfig) {
          firebase.initializeApp(window.firebaseConfig);
        }

    // STEP 2: DECLARE GLOBAL VARIABLES
        let auth, db, storage;
        let scenarios = [];
        let activeView = 'sessions';
        let currentGroupName = '';
        let sessionListener = null;
        let editingScenarioId = null; 
        
        const appView = document.getElementById('app-view');

    // STEP 3: SET UP THE DOM EVENT LISTENER
        document.addEventListener('DOMContentLoaded', () => {
            const checkFirebase = setInterval(() => {
                if (typeof firebase !== 'undefined' && typeof firebase.app === 'function' && firebase.apps.length > 0) {
                    try {
                        clearInterval(checkFirebase);
                        auth = firebase.auth();
                        db = firebase.firestore();
                        storage = firebase.storage();
                        main();
                    } catch (e) {
                        console.error("Error initializing Firebase services", e);
                    }
                }
            }, 50);
        });
        
    // STEP 4: APPLICATION FUNCTIONS
        function main() {
            showView('loading-view');
            auth.onAuthStateChanged(async (user) => {
                if (sessionListener) {
                    sessionListener();
                    sessionListener = null;
                }
                if (user) {
                    try {
                        const userProfileDoc = await db.collection('users').doc(user.uid).get();
                        if (userProfileDoc.exists && userProfileDoc.data().role === 'facilitator') {
                            await loadScenariosFromDB();
                            document.getElementById('header-controls').classList.remove('hidden');
                            document.getElementById('app-nav').classList.remove('hidden');
                            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
                            
                            document.getElementById('nav-sessions').addEventListener('click', (e) => { e.preventDefault(); activeView = 'sessions'; renderAppNavigationView(); });
                            document.getElementById('nav-scenarios').addEventListener('click', (e) => { e.preventDefault(); activeView = 'scenarios'; renderAppNavigationView(); });
                            document.getElementById('nav-admin').addEventListener('click', (e) => { e.preventDefault(); activeView = 'admin'; renderAppNavigationView(); });
                            
                            showView('app-view');
                            renderAppNavigationView();
                        } else {
                            showView('access-denied-view');
                            renderAccessDenied();
                        }
                    } catch (error) {
                        console.error("Critical Error on Load:", error);
                        showView('access-denied-view');
                    }
                } else {
                    document.getElementById('header-controls').classList.add('hidden');
                    document.getElementById('app-nav').classList.add('hidden');
                    showView('auth-view');
                    renderAuthForm();
                }
            });
        }

        async function loadScenariosFromDB() {
            try {
                const snapshot = await db.collection('scenarios').orderBy('id').get();
                scenarios = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
            } catch (error) {
                appView.innerHTML = `<div class="card p-8 text-center"><p class="text-red-500">Error: Could not load scenarios.</p></div>`;
                throw error;
            }
        }

        function showView(viewId) {
            ['loading-view', 'auth-view', 'app-view', 'access-denied-view'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const viewEl = document.getElementById(viewId);
            if (viewEl) viewEl.classList.remove('hidden');
        }

        function renderAppNavigationView() {
            appView.innerHTML = '';
            const tabs = {
                sessions: { navId: 'nav-sessions', renderFunc: renderGroupSelection },
                scenarios: { navId: 'nav-scenarios', renderFunc: renderScenarioEditor },
                admin: { navId: 'nav-admin', renderFunc: renderAdminPanel }
            };
            for (const key in tabs) {
                const navElement = document.getElementById(tabs[key].navId);
                navElement.className = (key === activeView) ? 'nav-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm' : 'nav-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';
            }
            if (tabs[activeView]) {
                tabs[activeView].renderFunc();
            }
        }
        
        function renderAuthForm() {
            const authView = document.getElementById('auth-view');
            authView.innerHTML = `<div class="card p-8 max-w-md mx-auto"><h2 class="text-xl font-bold text-gray-800 text-center">Facilitator Login</h2><div class="mt-6 space-y-4"><div><label for="login-email" class="block text-sm font-medium">Email</label><input type="email" id="login-email" class="mt-1 p-2 w-full border rounded-md"></div><div><label for="login-password" class="block text-sm font-medium">Password</label><input type="password" id="login-password" class="mt-1 p-2 w-full border rounded-md"></div><p id="login-error" class="text-red-500 text-sm hidden"></p><button id="login-btn" class="w-full btn btn-primary">Login</button></div></div>`;
            document.getElementById('login-btn').addEventListener('click', () => {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;
                const errorP = document.getElementById('login-error');
                errorP.classList.add('hidden');
                auth.signInWithEmailAndPassword(email, pass).catch(err => {
                    errorP.textContent = err.message;
                    errorP.classList.remove('hidden');
                });
            });
        }
        function renderAccessDenied() {
            const accessDeniedView = document.getElementById('access-denied-view');
            accessDeniedView.innerHTML = `<div class="card p-8 text-center max-w-md mx-auto"><h2 class="text-xl font-bold text-red-600">Access Denied</h2><p class="mt-2">You do not have permission to view this page.</p><button id="denied-logout-btn" class="mt-4 text-sm underline">Logout</button></div>`;
            document.getElementById('denied-logout-btn').addEventListener('click', () => auth.signOut());
        }

        function renderGroupSelection() {
            appView.innerHTML = `<div class="text-center card p-8"><h2 class="text-2xl font-bold">Select or Create Group</h2><div class="mt-6 max-w-sm mx-auto"><input type="text" id="group-name-input" class="p-3 w-full border rounded-md text-center" placeholder="e.g., Timperley-ST1-July"><button id="view-dashboard-btn" class="mt-4 w-full btn btn-primary">Continue</button></div></div>`;
            document.getElementById('view-dashboard-btn').addEventListener('click', async () => {
                const groupName = document.getElementById('group-name-input').value.trim();
                if (!groupName) return;
                currentGroupName = groupName;
                const sessionDoc = await db.collection('sessions').doc(groupName).get();
                if (sessionDoc.exists) showScenarioList(groupName); else renderSessionSetup(groupName);
            });
        }
        
        async function renderAdminPanel() {
            appView.innerHTML = `<div class="card p-6"><h2 class="text-2xl font-bold text-gray-800">User Management</h2><p class="text-gray-600 mt-2">Approve new trainees to access the Triage Tool.</p><div id="user-list" class="mt-6">Loading...</div></div>`;
            const userListContainer = document.getElementById('user-list');
            try {
                const usersSnapshot = await db.collection('users').where('role', '==', 'trainee').get();
                userListContainer.innerHTML = `<ul class="divide-y divide-gray-200"></ul>`;
                const list = userListContainer.querySelector('ul');
                if (usersSnapshot.empty) {
                    list.innerHTML = '<li><p class="text-gray-500 py-4">No trainees have signed up yet.</p></li>';
                    return;
                }
                usersSnapshot.docs.forEach(doc => {
                    const userData = doc.data();
                    const li = document.createElement('li');
                    li.className = 'py-4 flex items-center justify-between';
                    li.innerHTML = `<div><p class="font-medium">${userData.displayName}</p><p class="text-sm text-gray-500">${userData.email}</p></div>
                                    <div>${userData.status === 'approved' ? '<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">Approved</span>' : `<button data-uid="${doc.id}" class="btn btn-primary text-xs approve-btn">Approve</button>`}</div>`;
                    list.appendChild(li);
                });
                document.querySelectorAll('.approve-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.target.disabled = true;
                        await db.collection('users').doc(e.target.dataset.uid).update({ status: 'approved' });
                        renderAdminPanel();
                    });
                });
            } catch (error) { userListContainer.innerHTML = '<p class="text-red-500">Could not load user list.</p>'; }
        }

        function renderScenarioEditor() {
            editingScenarioId = null; 
            appView.innerHTML = `<div class="card p-6 w-full"><div class="flex justify-between items-center mb-6"><div><h2 class="text-2xl font-bold text-gray-800">Scenario Editor</h2><p class="text-gray-600 mt-2">Add, edit, or delete clinical scenarios.</p></div><button id="add-scenario-btn" class="btn btn-primary">Add New Scenario</button></div><div id="scenario-editor-list" class="mt-6 space-y-4"></div></div>`;
            document.getElementById('add-scenario-btn').addEventListener('click', () => renderScenarioForm());
            const listContainer = document.getElementById('scenario-editor-list');
            listContainer.innerHTML = '';
            if (!scenarios || scenarios.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">No scenarios found in the database.</p>';
                return;
            }

            scenarios.forEach(scenario => {
                if (!scenario) return; 

                const item = document.createElement('div');
                item.className = 'p-4 border rounded-lg flex flex-col sm:flex-row sm:items-center sm:justify-between bg-white';
                item.innerHTML = `<div class="flex-grow"><p class="font-bold">Case ${scenario.id}: ${scenario.name}, ${scenario.age}</p><p class="text-sm text-gray-600 mt-1 truncate-2-lines">${scenario.problem}</p></div><div class="flex-shrink-0 flex space-x-2 mt-4 sm:mt-0 sm:ml-4"><button data-id="${scenario.firestoreId}" class="btn text-sm bg-gray-200 hover:bg-gray-300 edit-btn">Edit</button><button data-id="${scenario.firestoreId}" data-name="Case ${scenario.id}: ${scenario.name}" class="btn text-sm bg-red-100 text-red-700 hover:bg-red-200 delete-btn">Delete</button></div>`;
                
                item.querySelector('.edit-btn').addEventListener('click', (e) => {
                    const firestoreId = e.target.dataset.id;
                    const scenarioToEdit = scenarios.find(s => s.firestoreId === firestoreId);
                    if (scenarioToEdit) {
                        renderScenarioForm(scenarioToEdit);
                    }
                });

                item.querySelector('.delete-btn').addEventListener('click', (e) => {
                    const firestoreId = e.target.dataset.id;
                    const scenarioName = e.target.dataset.name;
                    deleteScenario(firestoreId, scenarioName);
                });

                listContainer.appendChild(item);
            });
        }
        
        function renderScenarioForm(scenarioToEdit = null) {
            const isEditing = scenarioToEdit !== null;
            editingScenarioId = isEditing ? scenarioToEdit.firestoreId : null;

            const title = isEditing ? "Edit Scenario" : "Add New Scenario";
            const buttonText = isEditing ? "Save Changes" : "Save Scenario";

            let existingAttachmentHtml = '';
            // ** THE FIX IS HERE **
            // This check is now much safer. It ensures 'attachments' is a non-empty string before trying to split it.
            if (isEditing && typeof scenarioToEdit.attachments === 'string' && scenarioToEdit.attachments.length > 0) {
                existingAttachmentHtml = `<div class="text-xs text-gray-500 mt-2">Current file: <a href="${scenarioToEdit.attachments}" target="_blank" class="underline">${decodeURIComponent(scenarioToEdit.attachments.split('%2F').pop().split('?')[0])}</a></div>`;
            }

            appView.innerHTML = `<div class="card p-8 max-w-3xl mx-auto"><h2 class="text-2xl font-bold text-gray-800">${title}</h2><form id="scenario-form" class="mt-6 space-y-6"><fieldset class="space-y-4 border-t pt-6"><legend class="text-lg font-semibold text-gray-700">Case Details</legend><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label for="id" class="block text-sm font-medium text-gray-700">Case ID (unique number)</label><input type="number" id="id" class="mt-1 p-2 w-full border rounded-md bg-gray-100" readonly required></div><div><label for="name" class="block text-sm font-medium text-gray-700">Patient Name</label><input type="text" id="name" class="mt-1 p-2 w-full border rounded-md" required></div><div><label for="age" class="block text-sm font-medium text-gray-700">Patient Age</label><input type="number" id="age" class="mt-1 p-2 w-full border rounded-md" required></div></div><div><label for="problem" class="block text-sm font-medium text-gray-700">Describe the problem</label><textarea id="problem" rows="4" class="mt-1 p-2 w-full border rounded-md" required></textarea></div><div><label for="attachments" class="block text-sm font-medium text-gray-700">Attach a photo (optional)</label><input type="file" id="attachments" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>${existingAttachmentHtml}</div><div><label for="durationAndProgression" class="block text-sm font-medium text-gray-700">How long has it been going on for? Is it getting better or worse?</label><input type="text" id="durationAndProgression" class="mt-1 p-2 w-full border rounded-md"></div><div><label for="selfHelp" class="block text-sm font-medium text-gray-700">Have you tried anything to help?</label><input type="text" id="selfHelp" class="mt-1 p-2 w-full border rounded-md"></div><div><label for="worried" class="block text-sm font-medium text-gray-700">Is there anything you're particularly worried about?</label><input type="text" id="worried" class="mt-1 p-2 w-full border rounded-md"></div></fieldset><fieldset class="space-y-4 border-t pt-6"><legend class="text-lg font-semibold text-gray-700">Contact & Expectations</legend><div><label for="expectations" class="block text-sm font-medium text-gray-700">What are your expectations for what we can do?</label><input type="text" id="expectations" class="mt-1 p-2 w-full border rounded-md"></div><div><label for="contactMethod" class="block text-sm font-medium text-gray-700">Contact method preference (e.g., Text, Phone Call)</label><input type="text" id="contactMethod" class="mt-1 p-2 w-full border rounded-md"></div><div><label for="preferredClinician" class="block text-sm font-medium text-gray-700">Preferred clinician to contact them</label><input type="text" id="preferredClinician" class="mt-1 p-2 w-full border rounded-md"></div></fieldset><fieldset class="space-y-4 border-t pt-6"><legend class="text-lg font-semibold text-gray-700">Model Answer</legend><p class="text-sm text-gray-500">Set the correct triage outcome for this case. For accepted answers, enter values separated by a comma (e.g., Red,Amber).</p><div class="p-4 bg-gray-50 rounded-lg"><label class="block text-sm font-medium text-gray-900">Urgency</label><div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="model-urgency-accepted" placeholder="Accepted urgencies (comma-separated)" class="p-2 border rounded-md"><input type="text" id="model-urgency-feedback" placeholder="Feedback for urgency" class="p-2 border rounded-md"></div></div><div class="p-4 bg-gray-50 rounded-lg"><label class="block text-sm font-medium text-gray-900">Consultation Type</label><div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="model-consultationType-accepted" placeholder="Accepted types (e.g., Face-to-face)" class="p-2 border rounded-md"><input type="text" id="model-consultationType-feedback" placeholder="Feedback for consultation type" class="p-2 border rounded-md"></div></div><div class="p-4 bg-gray-50 rounded-lg"><label class="block text-sm font-medium text-gray-900">Required With</label><div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="model-requiredWith-accepted" placeholder="Accepted clinicians (e.g., GP, ANP)" class="p-2 border rounded-md"><input type="text" id="model-requiredWith-feedback" placeholder="Feedback for required with" class="p-2 border rounded-md"></div></div></fieldset><p id="scenario-error" class="text-red-500 text-sm hidden"></p><div class="flex justify-end gap-4 pt-4"><button type="button" id="cancel-scenario-btn" class="btn bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" id="save-scenario-btn" class="btn btn-primary">${buttonText}</button></div></form></div>`;
            
            if (isEditing) {
                document.getElementById('id').value = scenarioToEdit.id || '';
                document.getElementById('name').value = scenarioToEdit.name || '';
                document.getElementById('age').value = scenarioToEdit.age || '';
                document.getElementById('problem').value = scenarioToEdit.problem || '';
                document.getElementById('durationAndProgression').value = scenarioToEdit.durationAndProgression || '';
                document.getElementById('selfHelp').value = scenarioToEdit.selfHelp || '';
                document.getElementById('worried').value = scenarioToEdit.worried || '';
                document.getElementById('expectations').value = scenarioToEdit.expectations || '';
                document.getElementById('contactMethod').value = scenarioToEdit.contactMethod || '';
                document.getElementById('preferredClinician').value = scenarioToEdit.preferredClinician || '';
                if (scenarioToEdit.modelAnswer) {
                    const { urgency, consultationType, requiredWith } = scenarioToEdit.modelAnswer;
                    if (urgency) { document.getElementById('model-urgency-accepted').value = (urgency.accepted || []).join(', '); document.getElementById('model-urgency-feedback').value = urgency.feedback || ''; }
                    if (consultationType) { document.getElementById('model-consultationType-accepted').value = (consultationType.accepted || []).join(', '); document.getElementById('model-consultationType-feedback').value = consultationType.feedback || ''; }
                    if (requiredWith) { document.getElementById('model-requiredWith-accepted').value = (requiredWith.accepted || []).join(', '); document.getElementById('model-requiredWith-feedback').value = requiredWith.feedback || ''; }
                }
            } else {
                const maxId = scenarios.reduce((max, s) => s.id > max ? s.id : max, 0);
                document.getElementById('id').value = maxId + 1;
            }
            
            document.getElementById('scenario-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (editingScenarioId) {
                    updateScenario(editingScenarioId);
                } else {
                    saveScenario();
                }
            });
            document.getElementById('cancel-scenario-btn').addEventListener('click', renderScenarioEditor);
        }

        async function saveScenario() {
            const saveBtn = document.getElementById('save-scenario-btn');
            const errorP = document.getElementById('scenario-error');
            saveBtn.disabled = true;
            errorP.classList.add('hidden');
            
            const file = document.getElementById('attachments').files[0];
            let attachmentUrl = "";

            if (file) {
                saveBtn.textContent = 'Uploading File...';
                const filePath = `scenario-attachments/${Date.now()}-${file.name}`;
                const storageRef = storage.ref(filePath);
                try {
                    const uploadTask = await storageRef.put(file);
                    attachmentUrl = await uploadTask.ref.getDownloadURL();
                } catch (error) {
                    console.error("Error uploading file:", error);
                    errorP.textContent = "File upload failed. Please try again.";
                    errorP.classList.remove('hidden');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Scenario';
                    return;
                }
            }

            saveBtn.textContent = 'Saving...';
            const processToArray = (str) => str.split(',').map(item => item.trim()).filter(item => item);
            try {
                const newScenario = {
                    id: parseInt(document.getElementById('id').value, 10),
                    name: document.getElementById('name').value.trim(),
                    age: parseInt(document.getElementById('age').value, 10),
                    problem: document.getElementById('problem').value.trim(),
                    attachments: attachmentUrl,
                    durationAndProgression: document.getElementById('durationAndProgression').value.trim(),
                    selfHelp: document.getElementById('selfHelp').value.trim(),
                    worried: document.getElementById('worried').value.trim(),
                    expectations: document.getElementById('expectations').value.trim(),
                    contactMethod: document.getElementById('contactMethod').value.trim(),
                    preferredClinician: document.getElementById('preferredClinician').value.trim(),
                    modelAnswer: {
                        urgency: { accepted: processToArray(document.getElementById('model-urgency-accepted').value), feedback: document.getElementById('model-urgency-feedback').value.trim() },
                        consultationType: { accepted: processToArray(document.getElementById('model-consultationType-accepted').value), feedback: document.getElementById('model-consultationType-feedback').value.trim() },
                        requiredWith: { accepted: processToArray(document.getElementById('model-requiredWith-accepted').value), feedback: document.getElementById('model-requiredWith-feedback').value.trim() }
                    }
                };

                if (!newScenario.id || !newScenario.name || !newScenario.age || !newScenario.problem) {
                    errorP.textContent = "Case ID, Name, Age, and Problem fields are required.";
                    errorP.classList.remove('hidden');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Scenario';
                    return;
                }
                
                await db.collection('scenarios').add(newScenario);
                await loadScenariosFromDB();
                renderScenarioEditor();
            } catch (error) {
                console.error("Error saving scenario:", error);
                errorP.textContent = "An error occurred while saving. Check console for details.";
                errorP.classList.remove('hidden');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Scenario';
            }
        }

        async function updateScenario(firestoreId) {
            const saveBtn = document.getElementById('save-scenario-btn');
            const errorP = document.getElementById('scenario-error');
            saveBtn.disabled = true;
            errorP.classList.add('hidden');

            const processToArray = (str) => str.split(',').map(item => item.trim()).filter(item => item);
            const updatedData = {
                id: parseInt(document.getElementById('id').value, 10),
                name: document.getElementById('name').value.trim(),
                age: parseInt(document.getElementById('age').value, 10),
                problem: document.getElementById('problem').value.trim(),
                durationAndProgression: document.getElementById('durationAndProgression').value.trim(),
                selfHelp: document.getElementById('selfHelp').value.trim(),
                worried: document.getElementById('worried').value.trim(),
                expectations: document.getElementById('expectations').value.trim(),
                contactMethod: document.getElementById('contactMethod').value.trim(),
                preferredClinician: document.getElementById('preferredClinician').value.trim(),
                modelAnswer: {
                    urgency: { accepted: processToArray(document.getElementById('model-urgency-accepted').value), feedback: document.getElementById('model-urgency-feedback').value.trim() },
                    consultationType: { accepted: processToArray(document.getElementById('model-consultationType-accepted').value), feedback: document.getElementById('model-consultationType-feedback').value.trim() },
                    requiredWith: { accepted: processToArray(document.getElementById('model-requiredWith-accepted').value), feedback: document.getElementById('model-requiredWith-feedback').value.trim() }
                }
            };

            const file = document.getElementById('attachments').files[0];

            try {
                if (file) {
                    saveBtn.textContent = 'Uploading File...';
                    const filePath = `scenario-attachments/${Date.now()}-${file.name}`;
                    const storageRef = storage.ref(filePath);
                    const uploadTask = await storageRef.put(file);
                    updatedData.attachments = await uploadTask.ref.getDownloadURL();
                } else {
                    const originalScenario = scenarios.find(s => s.firestoreId === firestoreId);
                    updatedData.attachments = originalScenario.attachments || "";
                }

                saveBtn.textContent = 'Saving...';
                await db.collection('scenarios').doc(firestoreId).update(updatedData);

                await loadScenariosFromDB();
                renderScenarioEditor();

            } catch (error) {
                console.error("Error updating scenario:", error);
                errorP.textContent = "An error occurred while saving changes. Check console for details.";
                errorP.classList.remove('hidden');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        async function deleteScenario(firestoreId, scenarioName) {
            if (!confirm(`Are you sure you want to permanently delete "${scenarioName}"?`)) {
                return;
            }
            try {
                await db.collection('scenarios').doc(firestoreId).delete();
                await loadScenariosFromDB();
                renderScenarioEditor();
            } catch (error) {
                console.error("Error deleting scenario:", error);
                alert("An error occurred while deleting the scenario. Please try again.");
            }
        }
        
        function renderSessionSetup(groupName) {
            appView.innerHTML = `<div id="session-setup-view" class="card p-8"><h2 class="text-2xl font-bold text-gray-800">Set Initial Appointment Slots</h2><p class="text-gray-600 mt-2">This is a new session for group: <strong>${groupName}</strong>.</p><div class="mt-4"><label class="flex items-center"><input type="checkbox" id="hub-mode-checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><span class="ml-2 text-gray-700">Enable Triage Hub Mode</span></label></div><div id="slot-inputs" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4"></div><div class="mt-8 flex justify-end gap-4"><button id="back-to-group-selection-btn" class="btn bg-gray-200">Back</button><button id="start-session-btn" class="btn bg-green-600 text-white hover:bg-green-700">Start Session</button></div></div>`;
            const slotInputsContainer = document.getElementById('slot-inputs');
            const urgencies = ['Red', 'Amber', 'Green'];
            const types = ['Face-to-face', 'Telephone', 'Video', 'eConsult / Message'];
            urgencies.forEach(urgency => types.forEach(type => {
                const id = `slot-${urgency}-${type.replace(/\s+/g, '-')}`;
                const defaultVal = (urgency === 'Green') ? 10 : (urgency === 'Amber' ? 5 : 2);
                slotInputsContainer.innerHTML += `<div><label for="${id}" class="block text-sm font-medium text-gray-700">${urgency} - ${type}</label><input type="number" id="${id}" value="${defaultVal}" min="0" class="mt-1 shadow-sm block w-full sm:text-sm border-gray-300 rounded-md p-2"></div>`;
            }));
            document.getElementById('back-to-group-selection-btn').addEventListener('click', renderGroupSelection);
            document.getElementById('start-session-btn').addEventListener('click', async () => {
                const hubMode = document.getElementById('hub-mode-checkbox').checked;
                const slots = {};
                urgencies.forEach(urgency => types.forEach(type => {
                    const key = `${urgency}|${type}`;
                    slots[key] = parseInt(document.getElementById(`slot-${urgency}-${type.replace(/\s+/g, '-')}`).value, 10) || 0;
                }));
                const scenarioStatus = {};
                if (hubMode) { scenarios.forEach(s => { scenarioStatus[s.id] = { status: 'unlocked', lockedBy: null, lockedAt: null }; }); }
                await db.collection('sessions').doc(groupName).set({ groupName, hubMode, slots, scenarioStatus });
                showScenarioList(groupName);
            });
        }

        function showScenarioList(groupName) {
            appView.innerHTML = `<div id="scenario-list-view"><div class="sm:flex sm:items-center sm:justify-between mb-4"><div><button id="back-to-group-btn" class="btn bg-gray-200 text-sm">← Change Group</button></div><div class="mt-4 sm:mt-0"><button id="clear-btn" class="btn bg-red-600 text-white hover:bg-red-700 text-sm">Clear All Group Data</button></div></div><div id="scenario-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div></div>`;
            document.getElementById('back-to-group-btn').addEventListener('click', () => { if (sessionListener) sessionListener(); renderGroupSelection(); });
            document.getElementById('clear-btn').addEventListener('click', () => clearGroupData(groupName));
            const container = document.getElementById('scenario-list-container');
            container.innerHTML = '<p class="col-span-full">Loading scenario statuses...</p>';
            if (sessionListener) sessionListener();
            sessionListener = db.collection('sessions').doc(groupName).onSnapshot(doc => {
                if (!doc.exists) { container.innerHTML = '<p class="col-span-full text-red-500">Session deleted.</p>'; return; }
                const sessionData = doc.data();
                container.innerHTML = '';
                scenarios.forEach(scenario => {
                    const card = document.createElement('div');
                    let statusHtml = '';
                    let cardClass = 'bg-white hover:bg-indigo-50 cursor-pointer';
                    if (sessionData.hubMode && sessionData.scenarioStatus && sessionData.scenarioStatus[scenario.id]) {
                        const statusInfo = sessionData.scenarioStatus[scenario.id];
                        let statusText = 'Available';
                        let statusClass = 'status-available';
                        if (statusInfo.status === 'locked') { statusText = `Locked by ${statusInfo.lockedBy}`; statusClass = 'status-locked'; } 
                        else if (statusInfo.status === 'completed') { statusText = `Completed by ${statusInfo.completedBy}`; statusClass = 'status-completed'; cardClass = 'case-card-completed'; }
                        statusHtml = `<div class="flex items-center mt-2 text-xs"><span class="status-dot ${statusClass}"></span>${statusText}</div>`;
                    }
                    card.className = `p-4 rounded-lg shadow hover:shadow-lg transition ${cardClass}`;
                    card.innerHTML = `<h3 class="font-bold text-gray-800">Case ${scenario.id}: ${scenario.name}</h3><p class="text-sm text-gray-600 mt-1 truncate-2-lines">${scenario.problem}</p>${statusHtml}`;
                    card.addEventListener('click', () => showDecisionDetails(scenario.id, `Case ${scenario.id}: ${scenario.name}`));
                    container.appendChild(card);
                });
            });
        }

        function showDecisionDetails(scenarioId, scenarioName) {
            if (sessionListener) sessionListener();
            appView.innerHTML = `<div id="decision-details-view"><button id="back-to-scenarios-btn" class="mb-4 btn btn-primary">← Back to Scenario List</button><div id="decision-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><p class="text-gray-500">Loading decisions...</p></div></div>`;
            document.getElementById('back-to-scenarios-btn').addEventListener('click', () => showScenarioList(currentGroupName));
            const decisionListContainer = document.getElementById('decision-list-container');
            db.collection("decisions").where("groupName", "==", currentGroupName).where("scenario.id", "==", scenarioId).orderBy("timestamp", "desc").get()
                .then(querySnapshot => {
                    decisionListContainer.innerHTML = '';
                    if (querySnapshot.empty) { decisionListContainer.innerHTML = `<p class="text-gray-500 col-span-full">No decisions saved.</p>`; return; }
                    querySnapshot.forEach(doc => {
                        const decision = doc.data();
                        const card = document.createElement('div');
                        card.className = `bg-white rounded-lg shadow p-5 border-l-8 urgency-${decision.urgency}`;
                        card.innerHTML = `<div class="flex justify-between items-start"><h3 class="font-bold text-lg">${decision.scenario.name}, ${decision.scenario.age}</h3><span class="text-xs font-bold uppercase px-2 py-1 rounded-full bg-gray-200 text-gray-700">${decision.gpName}</span></div><div class="mt-4 pt-4 border-t grid grid-cols-3 gap-2 text-center text-sm"><div><span class="block font-semibold text-gray-500 text-xs">URGENCY</span><span class="font-bold text-${decision.urgency.toLowerCase()}-600">${decision.urgency}</span></div><div><span class="block font-semibold text-gray-500 text-xs">TYPE</span><span class="font-bold">${decision.consultationType}</span></div><div><span class="block font-semibold text-gray-500 text-xs">WITH</span><span class="font-bold">${decision.requiredWith}</span></div></div><div class="mt-4"><h4 class="font-semibold text-sm">Plan / Rationale:</h4><p class="text-sm bg-gray-50 p-3 mt-1 rounded whitespace-pre-wrap">${decision.triageNotes || '(No notes)'}</p></div>`;
                        decisionListContainer.appendChild(card);
                    });
                }).catch(err => { console.error(err); decisionListContainer.innerHTML = `<p class="text-red-500">Error loading decisions.</p>`; });
        }
        
        async function clearGroupData(groupName) {
            if (!confirm(`Are you sure you want to delete ALL decisions and reset for "${groupName}"?`)) return;
            try {
                const decisionsSnapshot = await db.collection("decisions").where("groupName", "==", groupName).get();
                if (!decisionsSnapshot.empty) {
                    const batch = db.batch();
                    decisionsSnapshot.forEach(doc => { batch.delete(doc.ref); });
                    await batch.commit();
                }
                const sessionRef = db.collection('sessions').doc(groupName);
                const sessionDoc = await sessionRef.get();
                if (sessionDoc.exists) {
                    if (sessionDoc.data().hubMode) {
                        const newStatus = {};
                        scenarios.forEach(s => { newStatus[s.id] = { status: 'unlocked', lockedBy: null, lockedAt: null }; });
                        await sessionRef.update({ scenarioStatus: newStatus });
                    } else {
                        const newSlots = {};
                        const urgencies = ['Red', 'Amber', 'Green'];
                        const types = ['Face-to-face', 'Telephone', 'Video', 'eConsult / Message'];
                        urgencies.forEach(urgency => types.forEach(type => {
                            const key = `${urgency}|${type}`;
                            newSlots[key] = (urgency === 'Green') ? 10 : (urgency === 'Amber' ? 5 : 2);
                        }));
                        await sessionRef.update({ slots: newSlots });
                    }
                }
                alert(`Data for group "${groupName}" has been cleared.`);
                showScenarioList(groupName);
            } catch (error) {
                console.error("Error clearing group data: ", error);
                alert("An error occurred while clearing data.");
            }
        }
    </script>
</body>
</html>

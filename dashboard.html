<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triage Dashboard - Case Review</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .hidden { display: none; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .nav-active { border-bottom-color: #4f46e5; color: #111827; font-weight: 600; }
        .nav-inactive { border-bottom-color: transparent; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div id="header-controls" class="hidden max-w-6xl mx-auto p-4 flex justify-between items-center">
            <h1 id="header-title" class="text-2xl font-bold text-gray-800">Triage Dashboard</h1>
            <button id="logout-btn" class="ml-4 text-sm text-gray-500 hover:underline">Logout</button>
        </div>
         <div id="app-nav" class="hidden max-w-6xl mx-auto border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <a href="#" id="nav-sessions" class="nav-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Sessions</a>
                <a href="#" id="nav-scenarios" class="nav-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Scenario Editor</a>
                <a href="#" id="nav-admin" class="nav-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">User Management</a>
            </nav>
        </div>
    </header>
    <main class="p-4 sm:p-6 max-w-6xl mx-auto w-full">
        <div id="loading-view" class="text-center p-8"><p>Loading...</p></div>
        <div id="auth-view" class="hidden"></div>
        <div id="access-denied-view" class="hidden"></div>
        <div id="app-view" class="hidden w-full"></div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <script>
        if (window.firebaseConfig) { firebase.initializeApp(window.firebaseConfig); }
        let auth, db, storage;
        let scenarios = [];
        let activeView = 'sessions';
        let currentGroupName = '';
        let sessionListener = null;
        let editingScenarioId = null; 
        const appView = document.getElementById('app-view');

        document.addEventListener('DOMContentLoaded', () => {
            const checkFirebase = setInterval(() => {
                if (typeof firebase !== 'undefined' && firebase.app && typeof firebase.app === 'function' && firebase.apps.length > 0) {
                    try {
                        clearInterval(checkFirebase);
                        auth = firebase.auth();
                        db = firebase.firestore();
                        storage = firebase.storage();
                        main();
                    } catch (e) { console.error("Error initializing Firebase services", e); }
                }
            }, 50);
        });
        
        function main() {
            showView('loading-view');
            auth.onAuthStateChanged(async (user) => {
                if (sessionListener) { sessionListener(); sessionListener = null; }
                if (user) {
                    try {
                        const userProfileDoc = await db.collection('users').doc(user.uid).get();
                        if (userProfileDoc.exists && userProfileDoc.data().role === 'facilitator') {
                            await loadScenariosFromDB();
                            document.getElementById('header-controls').classList.remove('hidden');
                            document.getElementById('app-nav').classList.remove('hidden');
                            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
                            document.getElementById('nav-sessions').addEventListener('click', (e) => { e.preventDefault(); activeView = 'sessions'; renderAppNavigationView(); });
                            document.getElementById('nav-scenarios').addEventListener('click', (e) => { e.preventDefault(); activeView = 'scenarios'; renderAppNavigationView(); });
                            document.getElementById('nav-admin').addEventListener('click', (e) => { e.preventDefault(); activeView = 'admin'; renderAppNavigationView(); });
                            showView('app-view');
                            renderAppNavigationView();
                        } else {
                            showView('access-denied-view');
                            renderAccessDenied();
                        }
                    } catch (error) {
                        console.error("Critical Error on Load:", error);
                        showView('access-denied-view');
                    }
                } else {
                    document.getElementById('header-controls').classList.add('hidden');
                    document.getElementById('app-nav').classList.add('hidden');
                    showView('auth-view');
                    renderAuthForm();
                }
            });
        }

        async function loadScenariosFromDB() {
            try {
                const snapshot = await db.collection('scenarios').orderBy('id').get();
                scenarios = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
            } catch (error) {
                appView.innerHTML = `<div class="card p-8 text-center"><p class="text-red-500">Error: Could not load scenarios.</p></div>`;
                throw error;
            }
        }

        function showView(viewId) {
            ['loading-view', 'auth-view', 'app-view', 'access-denied-view'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const viewEl = document.getElementById(viewId);
            if (viewEl) viewEl.classList.remove('hidden');
        }

        function renderAppNavigationView() {
            appView.innerHTML = '';
            const tabs = {
                sessions: { navId: 'nav-sessions', renderFunc: renderGroupSelection },
                scenarios: { navId: 'nav-scenarios', renderFunc: renderScenarioEditor },
                admin: { navId: 'nav-admin', renderFunc: renderAdminPanel }
            };
            for (const key in tabs) {
                const navElement = document.getElementById(tabs[key].navId);
                navElement.className = (key === activeView) ? 'nav-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm' : 'nav-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';
            }
            if (tabs[activeView]) {
                tabs[activeView].renderFunc();
            }
        }
        
        function renderAuthForm() {
            // ... (omitted for brevity, this function is correct) ...
        }
        function renderAccessDenied() {
            // ... (omitted for brevity, this function is correct) ...
        }
        function renderGroupSelection() {
            // ... (omitted for brevity, this function is correct) ...
        }
        async function renderAdminPanel() {
            // ... (omitted for brevity, this function is correct) ...
        }
        function renderScenarioEditor() {
            // ... (omitted for brevity, this function is correct) ...
        }
        function renderScenarioForm(scenarioToEdit = null) {
            // ... (omitted for brevity, this function is correct) ...
        }
        async function saveScenario() {
            // ... (omitted for brevity, this function is correct) ...
        }
        async function updateScenario(firestoreId) {
            // ... (omitted for brevity, this function is correct) ...
        }
        async function deleteScenario(firestoreId, scenarioName) {
            // ... (omitted for brevity, this function is correct) ...
        }
        
        function renderSessionSetup(groupName) {
            appView.innerHTML = `<div id="session-setup-view" class="card p-8"><h2 class="text-2xl font-bold text-gray-800">Set Initial Appointment Slots</h2><p class="text-gray-600 mt-2">This is a new session for group: <strong>${groupName}</strong>.</p><div class="mt-4"><label class="flex items-center"><input type="checkbox" id="hub-mode-checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><span class="ml-2 text-gray-700">Enable Triage Hub Mode</span></label></div><div id="slot-inputs" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4"></div><div class="mt-8 flex justify-end gap-4"><button id="back-to-group-selection-btn" class="btn bg-gray-200">Back</button><button id="start-session-btn" class="btn bg-green-600 text-white hover:bg-green-700">Start Session</button></div></div>`;
            const slotInputsContainer = document.getElementById('slot-inputs');
            const urgencies = ['Red', 'Amber', 'Green'];
            const types = ['Face-to-face', 'Telephone', 'Video', 'eConsult - Message']; // ** MODIFIED HERE **
            urgencies.forEach(urgency => types.forEach(type => {
                const safeType = type.replace(' / ', ' - '); // Ensure consistency
                const id = `slot-${urgency}-${safeType.replace(/\s+/g, '-')}`;
                const defaultVal = (urgency === 'Green') ? 10 : (urgency === 'Amber' ? 5 : 2);
                slotInputsContainer.innerHTML += `<div><label for="${id}" class="block text-sm font-medium text-gray-700">${urgency} - ${type}</label><input type="number" id="${id}" value="${defaultVal}" min="0" class="mt-1 shadow-sm block w-full sm:text-sm border-gray-300 rounded-md p-2"></div>`;
            }));
            document.getElementById('back-to-group-selection-btn').addEventListener('click', renderGroupSelection);
            document.getElementById('start-session-btn').addEventListener('click', async () => {
                const hubMode = document.getElementById('hub-mode-checkbox').checked;
                const slots = {};
                const urgencies = ['Red', 'Amber', 'Green'];
                const types = ['Face-to-face', 'Telephone', 'Video', 'eConsult - Message']; // ** MODIFIED HERE **
                urgencies.forEach(urgency => types.forEach(type => {
                    const safeType = type.replace(' / ', ' - '); // ** THIS IS THE FIX **
                    const key = `${urgency}|${safeType}`;
                    const inputId = `slot-${urgency}-${safeType.replace(/\s+/g, '-')}`;
                    slots[key] = parseInt(document.getElementById(inputId).value, 10) || 0;
                }));
                const scenarioStatus = {};
                if (hubMode) { scenarios.forEach(s => { scenarioStatus[s.id] = { status: 'unlocked', lockedBy: null, lockedAt: null }; }); }
                await db.collection('sessions').doc(groupName).set({ groupName, hubMode, slots, scenarioStatus });
                showScenarioList(groupName);
            });
        }
        
        // ... all other functions like showScenarioList, handleFileImport etc.
    </script>
</body>
</html>

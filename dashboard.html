<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triage Dashboard - Case Review</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .hidden { display: none; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .nav-active { border-bottom-color: #4f46e5; color: #111827; font-weight: 600; }
        .nav-inactive { border-bottom-color: transparent; color: #6b7280; }
        .urgency-Red { border-left-color: #dc2626; }
        .urgency-Amber { border-left-color: #d97706; }
        .urgency-Green { border-left-color: #16a34a; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div id="header-controls" class="hidden max-w-6xl mx-auto p-4 flex justify-between items-center">
            <h1 id="header-title" class="text-2xl font-bold text-gray-800">Triage Dashboard</h1>
            <button id="logout-btn" class="ml-4 text-sm text-gray-500 hover:underline">Logout</button>
        </div>
         <div id="app-nav" class="hidden max-w-6xl mx-auto border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <a href="#" id="nav-sessions" class="nav-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Sessions</a>
                <a href="#" id="nav-scenarios" class="nav-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Scenario Editor</a>
                <a href="#" id="nav-admin" class="nav-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">User Management</a>
            </nav>
        </div>
    </header>
    <main class="p-4 sm:p-6 max-w-6xl mx-auto">
        <div id="loading-view" class="text-center p-8"><p>Loading...</p></div>
        <div id="auth-view" class="hidden"></div>
        <div id="access-denied-view" class="hidden"></div>
        <div id="app-view" class="hidden"></div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script>
        // These variables will be initialized by the injected Netlify snippet
        let auth;
        let db;
        let storage;
        
        let scenarios = [];
        let activeView = 'sessions';
        let currentGroupName = '';
        let sessionListener = null;
        
        const appView = document.getElementById('app-view');

        async function loadScenariosFromDB() {
            try {
                const snapshot = await db.collection('scenarios').orderBy('id').get();
                scenarios = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
            } catch (error) {
                appView.innerHTML = `<div class="card p-8 text-center"><p class="text-red-500">Error: Could not load scenarios. Check Firestore Rules.</p></div>`;
                throw error;
            }
        }

        function showView(viewId) {
            ['loading-view', 'auth-view', 'app-view', 'access-denied-view'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const viewEl = document.getElementById(viewId);
            if (viewEl) viewEl.classList.remove('hidden');
        }

        auth.onAuthStateChanged(async (user) => {
            if (sessionListener) sessionListener();
            if (user) {
                try {
                    const userProfileDoc = await db.collection('users').doc(user.uid).get();
                    if (userProfileDoc.exists && userProfileDoc.data().role === 'facilitator') {
                        await loadScenariosFromDB();
                        document.getElementById('header-controls').classList.remove('hidden');
                        document.getElementById('app-nav').classList.remove('hidden');
                        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
                        
                        document.getElementById('nav-sessions').addEventListener('click', (e) => { e.preventDefault(); activeView = 'sessions'; renderAppNavigationView(); });
                        document.getElementById('nav-scenarios').addEventListener('click', (e) => { e.preventDefault(); activeView = 'scenarios'; renderAppNavigationView(); });
                        document.getElementById('nav-admin').addEventListener('click', (e) => { e.preventDefault(); activeView = 'admin'; renderAppNavigationView(); });
                        
                        showView('app-view');
                        renderAppNavigationView();
                    } else {
                        showView('access-denied-view');
                        renderAccessDenied();
                    }
                } catch (error) {
                    console.error("Critical Error on Load:", error);
                    showView('access-denied-view');
                    document.getElementById('access-denied-view').innerHTML = `<div class="card p-8 text-center"><h2 class="text-xl font-bold text-red-600">Application Error</h2><p class="text-gray-600 mt-2">Could not load required data. Please check the developer console.</p></div>`;
                }
            } else {
                document.getElementById('header-controls').classList.add('hidden');
                document.getElementById('app-nav').classList.add('hidden');
                showView('auth-view');
                renderAuthForm();
            }
        });
        
        function renderAppNavigationView() {
            appView.innerHTML = '';
            const tabs = {
                sessions: { navId: 'nav-sessions', renderFunc: renderGroupSelection },
                scenarios: { navId: 'nav-scenarios', renderFunc: renderScenarioEditor },
                admin: { navId: 'nav-admin', renderFunc: renderAdminPanel }
            };
            for (const key in tabs) {
                const navElement = document.getElementById(tabs[key].navId);
                if (key === activeView) navElement.classList.replace('nav-inactive', 'nav-active');
                else navElement.classList.replace('nav-active', 'nav-inactive');
            }
            if (tabs[activeView]) tabs[activeView].renderFunc();
        }
        
        // --- ALL OTHER FUNCTIONS (renderScenarioEditor, handleSaveScenario, etc.) GO HERE ---
        // --- These functions are unchanged from the last working file, but are included in full below ---

        function renderScenarioEditor() {
            appView.innerHTML = `<div class="card p-6"><div class="flex justify-between items-center mb-6"><div><h2 class="text-2xl font-bold text-gray-800">Scenario Editor</h2><p class="text-gray-600 mt-2">Add, edit, or delete clinical scenarios.</p></div><button id="add-scenario-btn" class="btn btn-primary">Add New Scenario</button></div><div id="scenario-editor-list" class="mt-6 space-y-4"></div></div>`;
            document.getElementById('add-scenario-btn').addEventListener('click', () => renderScenarioForm());
            const listContainer = document.getElementById('scenario-editor-list');
            if (!scenarios || scenarios.length === 0) { listContainer.innerHTML = '<p class="text-gray-500">No scenarios found in the database.</p>'; return; }
            scenarios.forEach(scenario => {
                const item = document.createElement('div');
                item.className = 'p-4 border rounded-lg flex flex-col sm:flex-row sm:items-center sm:justify-between bg-white';
                item.innerHTML = `<div class="flex-grow"><p class="font-bold">Case ${scenario.id}: ${scenario.name}, ${scenario.age}</p><p class="text-sm text-gray-600 mt-1">${scenario.problem}</p></div><div class="flex-shrink-0 flex space-x-2 mt-4 sm:mt-0 sm:ml-4"><button class="btn text-sm bg-gray-200 hover:bg-gray-300">Edit</button><button class="btn text-sm bg-red-100 text-red-700 hover:bg-red-200">Delete</button></div>`;
                listContainer.appendChild(item);
            });
        }
        
        function renderScenarioForm(scenario = {}) {
            const isEditing = scenario.firestoreId;
            const modelAnswer = scenario.modelAnswer || {};
            appView.innerHTML = `<div class="card p-6"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800">${isEditing ? 'Edit Scenario' : 'Add New Scenario'}</h2><button id="back-to-editor-btn" class="btn bg-gray-200">‚Üê Back to Editor</button></div><div id="form-error" class="hidden p-3 mb-4 text-red-700 bg-red-100 rounded-lg"></div><div class="space-y-6"></div><div class="flex justify-end mt-6"><button id="save-scenario-btn" class="btn btn-primary">${isEditing ? 'Save Changes' : 'Save New Scenario'}</button></div></div>`;
            const formContainer = appView.querySelector('.space-y-6');
            formContainer.innerHTML = `<div class="p-4 border rounded-lg"><h3 class="text-lg font-semibold mb-3">Basic Details</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-sm font-medium">Case ID (number)</label><input type="number" id="form-id" class="mt-1 p-2 w-full border rounded-md" value="${scenario.id || ''}"></div><div><label class="block text-sm font-medium">Patient Name</label><input type="text" id="form-name" class="mt-1 p-2 w-full border rounded-md" value="${scenario.name || ''}"></div><div><label class="block text-sm font-medium">Patient Age</label><input type="number" id="form-age" class="mt-1 p-2 w-full border rounded-md" value="${scenario.age || ''}"></div></div></div><div class="p-4 border rounded-lg space-y-4"><h3 class="text-lg font-semibold">Patient Triage Information</h3><div><label class="block text-sm font-medium">Describe the problem:</label><textarea id="form-problem" rows="4" class="mt-1 p-2 w-full border rounded-md">${scenario.problem || ''}</textarea></div><div><label class="block text-sm font-medium">Attach a photo:</label><input type="file" id="form-photo" class="mt-1 w-full text-sm"></div><div><label class="block text-sm font-medium">How long has it been going on for?:</label><textarea id="form-durationAndProgression" rows="2" class="mt-1 p-2 w-full border rounded-md">${scenario.durationAndProgression || ''}</textarea></div><div><label class="block text-sm font-medium">Have you tried anything to help?:</label><textarea id="form-selfHelp" rows="2" class="mt-1 p-2 w-full border rounded-md">${scenario.selfHelp || ''}</textarea></div><div><label class="block text-sm font-medium">What are you worried about?:</label><textarea id="form-worries" rows="2" class="mt-1 p-2 w-full border rounded-md">${scenario.worries || ''}</textarea></div><div><label class="block text-sm font-medium">Expectations:</label><textarea id="form-expectations" rows="2" class="mt-1 p-2 w-full border rounded-md">${scenario.expectations || ''}</textarea></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-sm font-medium">Best times to contact:</label><input type="text" id="form-contactTimes" class="mt-1 p-2 w-full border rounded-md" value="${scenario.contactTimes || ''}"></div><div><label class="block text-sm font-medium">Contact method preference:</label><input type="text" id="form-contactMethod" class="mt-1 p-2 w-full border rounded-md" value="${scenario.contactMethod || ''}"></div><div><label class="block text-sm font-medium">Preferred clinician:</label><input type="text" id="form-preferredClinician" class="mt-1 p-2 w-full border rounded-md" value="${scenario.preferredClinician || ''}"></div></div></div><div class="p-4 border rounded-lg space-y-4 bg-indigo-50"><h3 class="text-lg font-semibold">Model Answer & Feedback</h3><div><label class="block text-sm font-medium">Urgency: Accepted Values (comma-separated)</label><input type="text" id="form-urgency-accepted" class="mt-1 p-2 w-full border rounded-md" value="${(modelAnswer.urgency?.accepted || []).join(', ')}" placeholder="e.g., Red, Amber"> <label class="block text-sm font-medium mt-2">Urgency: Feedback Text</label><textarea id="form-urgency-feedback" rows="2" class="mt-1 p-2 w-full border rounded-md">${modelAnswer.urgency?.feedback || ''}</textarea></div><div><label class="block text-sm font-medium">Consultation Type: Accepted Values (comma-separated)</label><input type="text" id="form-type-accepted" class="mt-1 p-2 w-full border rounded-md" value="${(modelAnswer.consultationType?.accepted || []).join(', ')}" placeholder="e.g., Face-to-face, Telephone"><label class="block text-sm font-medium mt-2">Consultation Type: Feedback Text</label><textarea id="form-type-feedback" rows="2" class="mt-1 p-2 w-full border rounded-md">${modelAnswer.consultationType?.feedback || ''}</textarea></div><div><label class="block text-sm font-medium">Required With: Accepted Values (comma-separated)</label><input type="text" id="form-with-accepted" class="mt-1 p-2 w-full border rounded-md" value="${(modelAnswer.requiredWith?.accepted || []).join(', ')}" placeholder="e.g., GP, ANP"><label class="block text-sm font-medium mt-2">Required With: Feedback Text</label><textarea id="form-with-feedback" rows="2" class="mt-1 p-2 w-full border rounded-md">${modelAnswer.requiredWith?.feedback || ''}</textarea></div></div>`;
            document.getElementById('back-to-editor-btn').addEventListener('click', renderScenarioEditor);
            document.getElementById('save-scenario-btn').addEventListener('click', () => handleSaveScenario(scenario));
        }

        async function handleSaveScenario(scenario) {
            const saveBtn = document.getElementById('save-scenario-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            try {
                let photoURL = scenario.photoURL || '';
                const photoFile = document.getElementById('form-photo').files[0];
                if (photoFile) {
                    const filePath = `images/scenarios/${Date.now()}-${photoFile.name}`;
                    const fileRef = storage.ref().child(filePath);
                    await fileRef.put(photoFile);
                    photoURL = await fileRef.getDownloadURL();
                }
                const scenarioData = {
                    id: parseInt(document.getElementById('form-id').value), name: document.getElementById('form-name').value, age: parseInt(document.getElementById('form-age').value), problem: document.getElementById('form-problem').value, durationAndProgression: document.getElementById('form-durationAndProgression').value, selfHelp: document.getElementById('form-selfHelp').value, worries: document.getElementById('form-worries').value, expectations: document.getElementById('form-expectations').value, contactTimes: document.getElementById('form-contactTimes').value, contactMethod: document.getElementById('form-contactMethod').value, preferredClinician: document.getElementById('form-preferredClinician').value, photoURL: photoURL,
                    modelAnswer: {
                        urgency: { accepted: document.getElementById('form-urgency-accepted').value.split(',').map(s => s.trim()).filter(Boolean), feedback: document.getElementById('form-urgency-feedback').value },
                        consultationType: { accepted: document.getElementById('form-type-accepted').value.split(',').map(s => s.trim()).filter(Boolean), feedback: document.getElementById('form-type-feedback').value },
                        requiredWith: { accepted: document.getElementById('form-with-accepted').value.split(',').map(s => s.trim()).filter(Boolean), feedback: document.getElementById('form-with-feedback').value }
                    }
                };
                if (scenario.firestoreId) {
                    await db.collection('scenarios').doc(scenario.firestoreId).update(scenarioData);
                } else {
                    await db.collection('scenarios').add(scenarioData);
                }
                alert('Scenario saved!');
                await loadScenariosFromDB();
                renderScenarioEditor();
            } catch (error) {
                document.getElementById('form-error').textContent = `Error: ${error.message}`;
                document.getElementById('form-error').classList.remove('hidden');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = scenario.firestoreId ? 'Save Changes' : 'Save New Scenario';
            }
        }
    </script>
</body>
</html>
